<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>μΈν”„λ° μν™” μ •λ³΄ μ‚¬μ΄νΈ</title>
  <link rel="stylesheet" href="main.css" />
</head>
<body>
  <header class="header">
    <h1>μΈν”„λ° μν™” μ •λ³΄ μ‚¬μ΄νΈμ…λ‹λ‹¤.</h1>
    <nav>
      <a href="./index.html">λ©”μΈνμ΄μ§€</a>
      <a href="./login.html">λ΅κ·ΈμΈ</a>
      <a href="./signup.html">νμ›κ°€μ…</a>
    </nav>
  </header>

  <section class="search-bar">
    <input type="text" id="keyword" placeholder="ν‚¤μ›λ“λ¥Ό μ…λ ¥ν•μ„Έμ”." />
    <button onclick="filterMovies()">Filter results</button>
  </section>

  <main class="container">
    <aside class="filter-box">
      <h3>μ •λ ¬ κΈ°μ¤€</h3>
      <label><input type="radio" name="sort" value="ratingDesc" checked> ν‰μ  λ‚΄λ¦Όμ°¨μ</label><br>
      <label><input type="radio" name="sort" value="ratingAsc"> ν‰μ  μ¤λ¦„μ°¨μ</label><br>
      <label><input type="radio" name="sort" value="releaseDesc"> κ°λ΄‰ λ‚΄λ¦Όμ°¨μ</label><br>
      <label><input type="radio" name="sort" value="releaseAsc"> κ°λ΄‰ μ¤λ¦„μ°¨μ</label>
    </aside>

    <section>
      <h2>Movies</h2>
      <div id="movieList" class="movie-list"></div>
      <div id="loading">λ΅λ”© μ¤‘...</div>
    </section>
  </main>

  <script>
  let movies = [];
  let filteredMovies = [];
  let currentIndex = 0;
  const batchSize = 4;
  let isLoading = false;

  fetch('product.json')
    .then(res => res.json())
    .then(data => {
      movies = data;
      filterMovies();
    });

  function filterMovies() {
    const keyword = document.getElementById('keyword').value.toLowerCase();
    const sortValue = document.querySelector('input[name="sort"]:checked').value;

    filteredMovies = movies.filter(movie =>
      movie.title.toLowerCase().includes(keyword)
    );

    switch (sortValue) {
      case 'ratingDesc':
        filteredMovies.sort((a, b) => b.rating - a.rating);
        break;
      case 'ratingAsc':
        filteredMovies.sort((a, b) => a.rating - b.rating);
        break;
      case 'releaseDesc':
        filteredMovies.sort((a, b) => new Date(b.release) - new Date(a.release));
        break;
      case 'releaseAsc':
        filteredMovies.sort((a, b) => new Date(a.release) - new Date(b.release));
        break;
    }

    currentIndex = 0;
    document.getElementById('movieList').innerHTML = '';
    renderNextMovies();

    // β… μ¤ν¬λ΅¤μ΄ μ—†μ„ κ²½μ° κ°•μ  μ¶”κ°€ λ λ”λ§
    setTimeout(() => {
      if (document.documentElement.scrollHeight <= document.documentElement.clientHeight) {
        renderNextMovies();
      }
    }, 100);
  }

  function renderNextMovies() {
    const list = document.getElementById('movieList');
    const nextBatch = filteredMovies.slice(currentIndex, currentIndex + batchSize);

    if (nextBatch.length === 0) {
      document.getElementById('loading').style.display = 'none';
      return;
    }

    nextBatch.forEach(movie => {
      const card = document.createElement('div');
      card.className = 'movie-card';
      card.innerHTML = `
        <img src="${movie.poster}" alt="${movie.title}" />
        <div class="movie-desc">μ¤„κ±°λ¦¬:<br>${movie.description}</div>
        <div class="movie-info">
          <strong>${movie.title}</strong><br>
          π“… ${movie.release}<br>
          β­ ${movie.rating}/10
        </div>
      `;
      list.appendChild(card);
    });

    currentIndex += batchSize;
  }

  window.addEventListener('scroll', () => {
    if (isLoading) return;

    const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
    if (scrollTop + clientHeight >= scrollHeight - 5) {
      isLoading = true;
      document.getElementById('loading').style.display = 'block';

      setTimeout(() => {
        renderNextMovies();
        isLoading = false;

        // μ¤ν¬λ΅¤ λ” ν•„μ”ν• κ²½μ° λ‹¤μ‹ ν™•μΈ
        if (document.documentElement.scrollHeight <= document.documentElement.clientHeight) {
          renderNextMovies();
        }
      }, 300);
    }
  });
</script>

</body>
</html>